<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>EcoAtlas ‚Äì Tile Server Test</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@4.1.2/dist/maplibre-gl.css">
  <script src="https://unpkg.com/maplibre-gl@4.1.2/dist/maplibre-gl.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { background: #0d1117; color: #e6edf3; font-family: monospace; }

    #map { width: 100vw; height: 100vh; }

    #hud {
      position: absolute;
      top: 16px; left: 16px;
      background: rgba(13,17,23,0.92);
      border: 1px solid #30363d;
      border-radius: 8px;
      padding: 14px 18px;
      z-index: 10;
      min-width: 280px;
    }
    #hud h1 { font-size: 14px; color: #58a6ff; letter-spacing: 2px; margin-bottom: 10px; }
    #hud .row { display: flex; justify-content: space-between; font-size: 12px; margin: 4px 0; }
    #hud .label { color: #8b949e; }
    #hud .val   { color: #e6edf3; }
    #hud .dot   { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 6px; }
    .dot-green  { background: #4ade80; }
    .dot-yellow { background: #f59e0b; }
    .dot-red    { background: #f87171; }

    #tile-url {
      margin-top: 10px;
      padding: 8px;
      background: #161b22;
      border-radius: 4px;
      font-size: 10px;
      color: #8b949e;
      word-break: break-all;
    }

    #status-bar {
      position: absolute;
      bottom: 16px; left: 50%; transform: translateX(-50%);
      background: rgba(13,17,23,0.92);
      border: 1px solid #30363d;
      border-radius: 20px;
      padding: 8px 20px;
      font-size: 12px;
      color: #8b949e;
      z-index: 10;
    }
  </style>
</head>
<body>

<div id="hud">
  <h1>‚¨° ECOATLAS TILE SERVER</h1>
  <div class="row">
    <span class="label">Server</span>
    <span class="val"><span class="dot dot-green"></span>online</span>
  </div>
  <div class="row">
    <span class="label">Layer eco_core</span>
    <span class="val" id="core-status"><span class="dot dot-yellow"></span>leer (keine Daten)</span>
  </div>
  <div class="row">
    <span class="label">Layer eco_community</span>
    <span class="val" id="comm-status"><span class="dot dot-yellow"></span>leer (keine Daten)</span>
  </div>
  <div class="row">
    <span class="label">Zoom</span>
    <span class="val" id="zoom-val">5</span>
  </div>
  <div class="row">
    <span class="label">Tiles geladen</span>
    <span class="val" id="tile-count">0</span>
  </div>
  <div id="tile-url">
    GET /tiles/{z}/{x}/{y}.mvt
  </div>
</div>

<div id="map"></div>

<div id="status-bar">
  Community-Layer sichtbar ab Zoom 7 &nbsp;|&nbsp; Klick auf Marker f√ºr Details
</div>

<script>
const TILE_SERVER = 'https://ecoatlas-tile-server-nn46zdsrqa-ew.a.run.app';

const map = new maplibregl.Map({
  container: 'map',
  style: {
    version: 8,
    sources: {
      'osm': {
        type: 'raster',
        tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'],
        tileSize: 256,
        attribution: '¬© OpenStreetMap',
        maxzoom: 19
      }
    },
    layers: [{
      id: 'osm-tiles',
      type: 'raster',
      source: 'osm',
      paint: {
        'raster-opacity': 0.3,
        'raster-saturation': -0.8,
        'raster-brightness-min': 0.0,
        'raster-brightness-max': 0.3
      }
    }]
  },
  center: [10.4515, 51.1657], // Deutschland
  zoom: 5
});

let tileCount = 0;

map.on('load', () => {

  // ‚îÄ‚îÄ eco_core + eco_community Vector Tiles ‚îÄ‚îÄ
  map.addSource('ecoatlas', {
    type: 'vector',
    tiles: [`${TILE_SERVER}/tiles/{z}/{x}/{y}.mvt`],
    minzoom: 3,
    maxzoom: 18,
  });

  // eco_core ‚Äì verifizierte Standorte (blau)
  map.addLayer({
    id: 'eco-core-circle',
    type: 'circle',
    source: 'ecoatlas',
    'source-layer': 'eco_core',
    paint: {
      'circle-radius': ['interpolate', ['linear'], ['zoom'], 4, 4, 10, 10],
      'circle-color': '#60a5fa',
      'circle-opacity': 0.9,
      'circle-stroke-width': 1.5,
      'circle-stroke-color': '#1d4ed8',
    }
  });

  // eco_core ‚Äì Label
  map.addLayer({
    id: 'eco-core-label',
    type: 'symbol',
    source: 'ecoatlas',
    'source-layer': 'eco_core',
    minzoom: 8,
    layout: {
      'text-field': ['get', 'name'],
      'text-size': 11,
      'text-offset': [0, 1.2],
      'text-anchor': 'top',
    },
    paint: {
      'text-color': '#93c5fd',
      'text-halo-color': '#0d1117',
      'text-halo-width': 2,
    }
  });

  // eco_community ‚Äì Quarant√§ne (gelb, ab Zoom 7)
  map.addLayer({
    id: 'eco-community-circle',
    type: 'circle',
    source: 'ecoatlas',
    'source-layer': 'eco_community',
    minzoom: 7,
    paint: {
      'circle-radius': ['interpolate', ['linear'], ['zoom'], 7, 5, 12, 12],
      'circle-color': [
        'case',
        ['>=', ['get', 'vote_score'], 5], '#4ade80',
        ['>=', ['get', 'vote_score'], 0], '#f59e0b',
        '#f87171'
      ],
      'circle-opacity': 0.85,
      'circle-stroke-width': 1,
      'circle-stroke-color': '#0d1117',
    }
  });

  // ‚îÄ‚îÄ Klick Handler eco_core ‚îÄ‚îÄ
  map.on('click', 'eco-core-circle', async (e) => {
    const f = e.features?.[0];
    if (!f) return;
    const p = f.properties;
    const coords = (f.geometry as GeoJSON.Point).coordinates;

    // Detail von API holen
    let detail = null;
    try {
      const r = await fetch(`${TILE_SERVER}/api/emitter/${p.emitter_id}`);
      detail = await r.json();
    } catch {}

    new maplibregl.Popup({ maxWidth: '320px' })
      .setLngLat([coords[0], coords[1]])
      .setHTML(`
        <div style="background:#161b22;color:#e6edf3;padding:12px;border-radius:6px;font-family:monospace;font-size:12px;">
          <div style="color:#60a5fa;font-size:13px;font-weight:bold;margin-bottom:8px;">${p.name}</div>
          <div style="color:#8b949e;">Typ: <span style="color:#e6edf3;">${p.emitter_type}</span></div>
          <div style="color:#8b949e;">Aktiv: <span style="color:#e6edf3;">${p.active_from ?? '?'} ‚Äì ${p.active_to ?? 'heute'}</span></div>
          ${p.responsible_entity ? `<div style="color:#8b949e;">Verantwortlich: <span style="color:#e6edf3;">${p.responsible_entity}</span></div>` : ''}
          ${detail?.measurements?.length ? `<div style="margin-top:8px;color:#8b949e;">${detail.measurements.length} Messung(en) vorhanden</div>` : ''}
          ${p.wiki_url ? `<div style="margin-top:6px;"><a href="${p.wiki_url}" target="_blank" style="color:#58a6ff;">‚Üí Wikipedia</a></div>` : ''}
          ${p.is_locked ? `<div style="margin-top:6px;color:#f59e0b;">üîí Team-gesperrt</div>` : ''}
        </div>
      `)
      .addTo(map);
  });

  // ‚îÄ‚îÄ Klick Handler eco_community ‚îÄ‚îÄ
  map.on('click', 'eco-community-circle', (e) => {
    const f = e.features?.[0];
    if (!f) return;
    const p = f.properties;
    const coords = (f.geometry as GeoJSON.Point).coordinates;

    new maplibregl.Popup({ maxWidth: '300px' })
      .setLngLat([coords[0], coords[1]])
      .setHTML(`
        <div style="background:#161b22;color:#e6edf3;padding:12px;border-radius:6px;font-family:monospace;font-size:12px;">
          <div style="color:#f59e0b;font-size:13px;font-weight:bold;margin-bottom:8px;">‚è≥ ${p.name}</div>
          <div style="color:#8b949e;">Status: <span style="color:#e6edf3;">${p.status}</span></div>
          <div style="color:#8b949e;">Votes: <span style="color:#4ade80;">‚ñ≤ ${p.upvotes}</span> <span style="color:#f87171;">‚ñº ${p.downvotes}</span></div>
          <div style="color:#8b949e;">Von: <span style="color:#e6edf3;">${p.user_display_name || 'Anonym'}</span></div>
          <div style="margin-top:6px;color:#8b949e;font-size:10px;">${p.created_at}</div>
        </div>
      `)
      .addTo(map);
  });

  // Cursor √§ndern bei Hover
  map.on('mouseenter', 'eco-core-circle',      () => { map.getCanvas().style.cursor = 'pointer'; });
  map.on('mouseleave', 'eco-core-circle',      () => { map.getCanvas().style.cursor = ''; });
  map.on('mouseenter', 'eco-community-circle', () => { map.getCanvas().style.cursor = 'pointer'; });
  map.on('mouseleave', 'eco-community-circle', () => { map.getCanvas().style.cursor = ''; });

  // Zoom anzeigen
  map.on('zoom', () => {
    document.getElementById('zoom-val').textContent = map.getZoom().toFixed(1);
  });

  // Tile-Counter
  map.on('data', (e) => {
    if (e.sourceId === 'ecoatlas' && e.dataType === 'tile') {
      tileCount++;
      document.getElementById('tile-count').textContent = tileCount;
      document.getElementById('tile-url').textContent =
        `GET /tiles/${Math.floor(map.getZoom())}/{x}/{y}.mvt`;
    }
  });
});
</script>
</body>
</html>