<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>EcoAtlas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@4.1.2/dist/maplibre-gl.css">
  <script src="https://unpkg.com/maplibre-gl@4.1.2/dist/maplibre-gl.js"></script>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { background:#1a1f2e; font-family: 'Segoe UI', system-ui, sans-serif; }
    #map { width:100vw; height:100vh; }

    /* â”€â”€ HUD links â”€â”€ */
    #hud {
      position:absolute; top:14px; left:14px;
      background:rgba(15,20,30,0.88);
      border:1px solid rgba(255,255,255,0.1);
      border-radius:10px; padding:14px 16px;
      z-index:10; min-width:240px;
      backdrop-filter: blur(8px);
    }
    #hud h1 {
      font-size:13px; font-weight:700;
      color:#60a5fa; letter-spacing:3px;
      margin-bottom:12px;
    }
    .row { display:flex; justify-content:space-between; align-items:center; font-size:12px; margin:4px 0; }
    .lbl { color:#94a3b8; }
    .val { color:#e2e8f0; }
    .dot { display:inline-block; width:8px; height:8px; border-radius:50%; margin-right:5px; }

    /* Helligkeit-Slider */
    #brightness-wrap {
      margin-top:12px; padding-top:10px;
      border-top:1px solid rgba(255,255,255,0.08);
    }
    #brightness-wrap label { font-size:11px; color:#94a3b8; display:block; margin-bottom:5px; }
    #brightness-slider {
      width:100%; accent-color:#60a5fa; cursor:pointer;
    }

    /* Layer Toggles */
    #layer-toggle {
      margin-top:10px; padding-top:10px;
      border-top:1px solid rgba(255,255,255,0.08);
    }
    .trow { display:flex; align-items:center; justify-content:space-between; margin:5px 0; font-size:12px; color:#cbd5e1; }
    input[type=checkbox] { accent-color:#60a5fa; cursor:pointer; width:14px; height:14px; }

    #osm-info {
      margin-top:8px; padding:6px 8px;
      background:rgba(0,0,0,0.3); border-radius:5px;
      font-size:10px; color:#64748b;
    }

    /* â”€â”€ Suchleiste oben Mitte â”€â”€ */
    #search-bar {
      position:absolute; top:14px; left:50%; transform:translateX(-50%);
      z-index:10; display:flex; gap:6px; align-items:stretch;
    }
    #search-input {
      width:300px; padding:9px 14px;
      background:rgba(15,20,30,0.92);
      border:1px solid rgba(255,255,255,0.15);
      border-radius:8px; color:#e2e8f0;
      font-size:13px; outline:none;
      backdrop-filter:blur(8px);
    }
    #search-input::placeholder { color:#475569; }
    #search-input:focus { border-color:#60a5fa; }
    #search-btn {
      padding:9px 14px;
      background:#1e40af; border:none; border-radius:8px;
      color:#e2e8f0; font-size:12px; cursor:pointer;
      white-space:nowrap;
    }
    #search-btn:hover { background:#2563eb; }

    /* Koordinaten-Expand */
    #coord-toggle {
      padding:9px 10px;
      background:rgba(15,20,30,0.92);
      border:1px solid rgba(255,255,255,0.15);
      border-radius:8px; color:#94a3b8;
      font-size:11px; cursor:pointer;
      white-space:nowrap; backdrop-filter:blur(8px);
    }
    #coord-panel {
      display:none;
      position:absolute; top:50px; left:50%; transform:translateX(-50%);
      background:rgba(15,20,30,0.95);
      border:1px solid rgba(255,255,255,0.12);
      border-radius:8px; padding:12px 16px;
      z-index:10; backdrop-filter:blur(8px);
      display:none; gap:8px; align-items:center; flex-wrap:wrap;
    }
    #coord-panel input {
      width:130px; padding:7px 10px;
      background:rgba(0,0,0,0.4);
      border:1px solid rgba(255,255,255,0.12);
      border-radius:6px; color:#e2e8f0; font-size:12px; outline:none;
    }
    #coord-panel input:focus { border-color:#60a5fa; }
    #coord-go {
      padding:7px 14px; background:#1e40af;
      border:none; border-radius:6px;
      color:#e2e8f0; font-size:12px; cursor:pointer;
    }
    #coord-go:hover { background:#2563eb; }

    /* Suchergebnisse */
    #search-results {
      position:absolute; top:52px; left:50%; transform:translateX(-50%);
      width:340px; background:rgba(15,20,30,0.97);
      border:1px solid rgba(255,255,255,0.12);
      border-radius:8px; z-index:11;
      max-height:200px; overflow-y:auto;
      display:none;
    }
    .sr-item {
      padding:9px 14px; font-size:12px; color:#cbd5e1;
      cursor:pointer; border-bottom:1px solid rgba(255,255,255,0.05);
    }
    .sr-item:hover { background:rgba(96,165,250,0.15); color:#e2e8f0; }

    /* Status unten */
    #statusbar {
      position:absolute; bottom:14px; left:50%; transform:translateX(-50%);
      background:rgba(15,20,30,0.88);
      border:1px solid rgba(255,255,255,0.08);
      border-radius:20px; padding:7px 18px;
      font-size:11px; color:#64748b; z-index:10;
      white-space:nowrap; backdrop-filter:blur(8px);
    }

    /* Koordinaten-Anzeige unten rechts */
    #coords-display {
      position:absolute; bottom:14px; right:14px;
      background:rgba(15,20,30,0.75);
      border:1px solid rgba(255,255,255,0.07);
      border-radius:6px; padding:5px 10px;
      font-size:10px; color:#475569; z-index:10;
      font-family:monospace;
    }
  </style>
</head>
<body>

<!-- HUD links -->
<div id="hud">
  <h1>â¬¡ ECOATLAS</h1>
  <div class="row"><span class="lbl">Tile-Server</span><span class="val"><span class="dot" style="background:#4ade80"></span>online</span></div>
  <div class="row"><span class="lbl">OSM Overpass</span><span class="val" id="osm-api-status"><span class="dot" style="background:#64748b"></span>wartend</span></div>
  <div class="row"><span class="lbl">Zoom</span><span class="val" id="zoom-val">5.0</span></div>

  <div id="brightness-wrap">
    <label>ðŸŒ™ Karten-Helligkeit: <span id="brightness-label">40%</span></label>
    <input type="range" id="brightness-slider" min="10" max="100" value="40">
  </div>

  <div id="layer-toggle">
    <div class="trow"><span><span class="dot" style="background:#a78bfa"></span>OSM Umwelt</span><input type="checkbox" id="toggle-osm" checked></div>
    <div class="trow"><span><span class="dot" style="background:#60a5fa"></span>eco_core</span><input type="checkbox" id="toggle-core" checked></div>
    <div class="trow"><span><span class="dot" style="background:#f59e0b"></span>eco_community</span><input type="checkbox" id="toggle-comm" checked></div>
  </div>

  <div id="osm-info">OSM: bewege die Karte zum Laden</div>
</div>

<!-- Suchleiste -->
<div id="search-bar">
  <input id="search-input" type="text" placeholder="Ort suchenâ€¦ z.B. Hamburg, MÃ¼nchen">
  <button id="search-btn">Suchen</button>
  <button id="coord-toggle" title="Per Koordinaten springen">âŠ• Koordinaten</button>
</div>

<!-- Koordinaten-Panel (ausgeklappt) -->
<div id="coord-panel">
  <input id="lat-input" type="number" placeholder="Breitengrad  z.B. 53.55" step="0.0001">
  <input id="lng-input" type="number" placeholder="LÃ¤ngengrad  z.B. 9.99" step="0.0001">
  <button id="coord-go">â†’ Gehe hin</button>
</div>

<!-- Suchergebnisse Dropdown -->
<div id="search-results"></div>

<div id="map"></div>
<div id="statusbar">Karte lÃ¤dtâ€¦</div>
<div id="coords-display">lat â€” | lng â€”</div>

<script>
const TILE_SERVER = 'https://ecoatlas-tile-server-nn46zdsrqa-ew.a.run.app';

// â”€â”€ OSM Umwelt-Typen â”€â”€
const OSM_QUERIES = [
  { key:'landuse',   val:'landfill',          label:'Deponie',          color:'#a78bfa' },
  { key:'man_made',  val:'wastewater_plant',  label:'KlÃ¤ranlage',       color:'#34d399' },
  { key:'man_made',  val:'chimney',           label:'Schornstein',      color:'#f87171' },
  { key:'industrial',val:'refinery',          label:'Raffinerie',       color:'#fb923c' },
  { key:'power',     val:'plant',             label:'Kraftwerk',        color:'#fbbf24' },
  { key:'landuse',   val:'quarry',            label:'Steinbruch',       color:'#94a3b8' },
  { key:'power',     val:'nuclear',           label:'Kernkraftwerk',    color:'#f43f5e' },
  { key:'industrial',val:'chemical',          label:'Chemiewerk',       color:'#e879f9' },
];

function buildOverpassQuery(bbox) {
  const {s,w,n,e} = bbox;
  const b = `${s},${w},${n},${e}`;
  const parts = [];
  OSM_QUERIES.forEach(q => {
    ['node','way','relation'].forEach(t =>
      parts.push(`  ${t}["${q.key}"="${q.val}"](${b});`)
    );
  });
  return `[out:json][timeout:25];\n(\n${parts.join('\n')}\n);\nout center tags;`;
}

function tagToMeta(tags) {
  for (const q of OSM_QUERIES) {
    if (tags[q.key] === q.val) return q;
  }
  return { label:'Sonstige', color:'#64748b' };
}

// â”€â”€ Karte â”€â”€
const map = new maplibregl.Map({
  container:'map',
  style:{
    version:8,
    sources:{
      osm:{
        type:'raster',
        tiles:['https://tile.openstreetmap.org/{z}/{x}/{y}.png'],
        tileSize:256,
        attribution:'Â© OpenStreetMap',
      }
    },
    layers:[{
      id:'osm-base', type:'raster', source:'osm',
      paint:{
        'raster-opacity':0.4,
        'raster-saturation':-0.5,
        'raster-brightness-min':0.05,
        'raster-brightness-max':0.55,
      }
    }]
  },
  center:[10.45,51.17],
  zoom:5,
});

map.addControl(new maplibregl.NavigationControl(), 'bottom-right');

// â”€â”€ Helligkeit Slider â”€â”€
document.getElementById('brightness-slider').addEventListener('input', function() {
  const v = this.value / 100;
  document.getElementById('brightness-label').textContent = this.value + '%';
  map.setPaintProperty('osm-base', 'raster-opacity',          Math.min(v, 0.95));
  map.setPaintProperty('osm-base', 'raster-brightness-max',   Math.min(v * 1.4, 1.0));
  map.setPaintProperty('osm-base', 'raster-saturation',       v > 0.6 ? 0 : -0.5);
});

// â”€â”€ Koordinaten Anzeige â”€â”€
map.on('mousemove', e => {
  document.getElementById('coords-display').textContent =
    `lat ${e.lngLat.lat.toFixed(5)} | lng ${e.lngLat.lng.toFixed(5)}`;
});

// â”€â”€ Koordinaten-Panel Toggle â”€â”€
let coordOpen = false;
document.getElementById('coord-toggle').addEventListener('click', () => {
  coordOpen = !coordOpen;
  document.getElementById('coord-panel').style.display = coordOpen ? 'flex' : 'none';
});

document.getElementById('coord-go').addEventListener('click', () => {
  const lat = parseFloat(document.getElementById('lat-input').value);
  const lng = parseFloat(document.getElementById('lng-input').value);
  if (isNaN(lat) || isNaN(lng)) return;
  map.flyTo({ center:[lng, lat], zoom:12, duration:1200 });
  document.getElementById('coord-panel').style.display = 'none';
  coordOpen = false;
  new maplibregl.Marker({ color:'#60a5fa' })
    .setLngLat([lng, lat])
    .addTo(map);
});

// â”€â”€ Ortssuche (Nominatim) â”€â”€
async function searchPlace(query) {
  if (!query.trim()) return;
  const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=5&accept-language=de`;
  try {
    const res  = await fetch(url, { headers:{ 'Accept-Language':'de' } });
    const data = await res.json();
    const box  = document.getElementById('search-results');

    if (!data.length) {
      box.innerHTML = '<div class="sr-item" style="color:#64748b">Keine Ergebnisse</div>';
      box.style.display = 'block';
      return;
    }

    box.innerHTML = data.map((r,i) =>
      `<div class="sr-item" data-i="${i}" data-lat="${r.lat}" data-lng="${r.lon}">${r.display_name}</div>`
    ).join('');
    box.style.display = 'block';

    box.querySelectorAll('.sr-item').forEach(el => {
      el.addEventListener('click', () => {
        const lat = parseFloat(el.dataset.lat);
        const lng = parseFloat(el.dataset.lng);
        map.flyTo({ center:[lng, lat], zoom:12, duration:1000 });
        box.style.display = 'none';
        document.getElementById('search-input').value = el.textContent.split(',')[0];
      });
    });
  } catch {
    document.getElementById('search-results').style.display = 'none';
  }
}

document.getElementById('search-btn').addEventListener('click', () =>
  searchPlace(document.getElementById('search-input').value)
);
document.getElementById('search-input').addEventListener('keydown', e => {
  if (e.key === 'Enter') searchPlace(e.target.value);
});
document.addEventListener('click', e => {
  if (!e.target.closest('#search-bar') && !e.target.closest('#search-results'))
    document.getElementById('search-results').style.display = 'none';
});

// â”€â”€ Karte geladen â”€â”€
map.on('load', () => {

  // OSM GeoJSON Source
  map.addSource('osm-env', {
    type:'geojson',
    data:{ type:'FeatureCollection', features:[] },
  });
  map.addLayer({
    id:'osm-env-circle', type:'circle', source:'osm-env',
    paint:{
      'circle-radius':['interpolate',['linear'],['zoom'],4,5,10,13],
      'circle-color':['get','color'],
      'circle-opacity':0.9,
      'circle-stroke-width':1.5,
      'circle-stroke-color':'rgba(0,0,0,0.5)',
    }
  });
  map.addLayer({
    id:'osm-env-label', type:'symbol', source:'osm-env', minzoom:9,
    layout:{
      'text-field':['get','name'],
      'text-size':11,
      'text-offset':[0,1.3],
      'text-anchor':'top',
    },
    paint:{
      'text-color':'#e2e8f0',
      'text-halo-color':'rgba(0,0,0,0.8)',
      'text-halo-width':2,
    }
  });

  // Tile-Server (BigQuery)
  map.addSource('ecoatlas', {
    type:'vector',
    tiles:[`${TILE_SERVER}/tiles/{z}/{x}/{y}.mvt`],
    minzoom:3, maxzoom:18,
  });
  map.addLayer({
    id:'eco-core-circle', type:'circle',
    source:'ecoatlas', 'source-layer':'eco_core',
    paint:{
      'circle-radius':['interpolate',['linear'],['zoom'],4,7,10,15],
      'circle-color':'#60a5fa',
      'circle-opacity':0.95,
      'circle-stroke-width':2,
      'circle-stroke-color':'#1d4ed8',
    }
  });
  map.addLayer({
    id:'eco-community-circle', type:'circle',
    source:'ecoatlas', 'source-layer':'eco_community', minzoom:7,
    paint:{
      'circle-radius':['interpolate',['linear'],['zoom'],7,6,12,13],
      'circle-color':['case',
        ['>=',['get','vote_score'],5],'#4ade80',
        ['>=',['get','vote_score'],0],'#f59e0b',
        '#f87171'
      ],
      'circle-opacity':0.9,
      'circle-stroke-width':1.5,
      'circle-stroke-color':'rgba(0,0,0,0.6)',
    }
  });

  // â”€â”€ OSM Overpass laden â”€â”€
  let loadTimer = null, lastBbox = null;

  const OVERPASS_ENDPOINTS = [
    'https://overpass-api.de/api/interpreter',
    'https://overpass.kumi.systems/api/interpreter',
  ];

  async function loadOsm() {
    const zoom = map.getZoom();
    if (zoom < 4) {
      document.getElementById('osm-info').textContent = 'OSM: bitte weiter reinzoomen (min. Zoom 4)';
      return;
    }
    const b = map.getBounds();
    const bbox = {
      s: b.getSouth().toFixed(3), w: b.getWest().toFixed(3),
      n: b.getNorth().toFixed(3), e: b.getEast().toFixed(3),
    };
    const key = JSON.stringify(bbox);
    if (key === lastBbox) return;
    lastBbox = key;

    document.getElementById('osm-api-status').innerHTML =
      '<span class="dot" style="background:#f59e0b"></span>lÃ¤dtâ€¦';
    document.getElementById('osm-info').textContent = 'OSM: Overpass Anfrageâ€¦';

    const query = buildOverpassQuery(bbox);
    let data = null;

    for (const ep of OVERPASS_ENDPOINTS) {
      try {
        const r = await fetch(ep, {
          method:'POST',
          body:'data=' + encodeURIComponent(query),
          signal: AbortSignal.timeout(28000),
        });
        if (r.ok) { data = await r.json(); break; }
      } catch { continue; }
    }

    if (!data) {
      document.getElementById('osm-api-status').innerHTML =
        '<span class="dot" style="background:#f87171"></span>Fehler';
      document.getElementById('osm-info').textContent = 'OSM: Overpass nicht erreichbar â€“ bitte erneut zoomen';
      return;
    }

    const features = data.elements.map(el => {
      const lat = el.lat ?? el.center?.lat;
      const lon = el.lon ?? el.center?.lon;
      if (!lat || !lon) return null;
      const tags = el.tags ?? {};
      const meta = tagToMeta(tags);
      return {
        type:'Feature',
        geometry:{ type:'Point', coordinates:[lon,lat] },
        properties:{
          osm_id: el.id,
          name:   tags.name ?? tags['name:de'] ?? meta.label,
          label:  meta.label,
          color:  meta.color,
          operator: tags.operator ?? '',
          tags_str: Object.entries(tags).slice(0,4).map(([k,v])=>`${k}=${v}`).join(' Â· '),
        }
      };
    }).filter(Boolean);

    map.getSource('osm-env').setData({ type:'FeatureCollection', features });

    document.getElementById('osm-api-status').innerHTML =
      '<span class="dot" style="background:#4ade80"></span>ok';
    document.getElementById('osm-info').textContent =
      `OSM: ${features.length} Standorte geladen`;
    document.getElementById('statusbar').textContent =
      `OSM: ${features.length} Umwelt-Standorte sichtbar  |  Zoom: ${zoom.toFixed(1)}  |  Klick fÃ¼r Details`;
  }

  map.on('moveend', () => { clearTimeout(loadTimer); loadTimer = setTimeout(loadOsm, 700); });
  map.on('zoomend', () => { clearTimeout(loadTimer); loadTimer = setTimeout(loadOsm, 700); });
  loadOsm();

  // â”€â”€ Zoom Anzeige â”€â”€
  map.on('zoom', () => {
    document.getElementById('zoom-val').textContent = map.getZoom().toFixed(1);
  });

  // â”€â”€ Klick Popups â”€â”€
  map.on('click','osm-env-circle', e => {
    const f = e.features?.[0]; if (!f) return;
    const p = f.properties, c = f.geometry.coordinates;
    new maplibregl.Popup({ maxWidth:'300px', className:'eco-popup' })
      .setLngLat([c[0],c[1]])
      .setHTML(`<div style="background:#0f1420;color:#e2e8f0;padding:12px;border-radius:6px;font-size:12px;">
        <div style="color:${p.color};font-weight:700;font-size:13px;margin-bottom:6px;">${p.label}</div>
        <div style="font-size:14px;margin-bottom:8px;">${p.name}</div>
        ${p.operator ? `<div style="color:#94a3b8;">Betreiber: <span style="color:#e2e8f0;">${p.operator}</span></div>` : ''}
        <div style="color:#475569;font-size:10px;margin-top:6px;">${p.tags_str}</div>
        <div style="color:#374151;font-size:10px;">OSM ID: ${p.osm_id}</div>
      </div>`)
      .addTo(map);
  });

  map.on('click','eco-core-circle', e => {
    const f = e.features?.[0]; if (!f) return;
    const p = f.properties, c = f.geometry.coordinates;
    new maplibregl.Popup({ maxWidth:'280px' })
      .setLngLat([c[0],c[1]])
      .setHTML(`<div style="background:#0f1420;color:#e2e8f0;padding:12px;border-radius:6px;font-size:12px;">
        <div style="color:#60a5fa;font-weight:700;margin-bottom:6px;">âœ“ VERIFIZIERT</div>
        <div style="font-size:14px;">${p.name}</div>
        <div style="color:#94a3b8;margin-top:4px;">Typ: ${p.emitter_type}</div>
      </div>`)
      .addTo(map);
  });

  // Cursor
  ['osm-env-circle','eco-core-circle','eco-community-circle'].forEach(id => {
    map.on('mouseenter', id, () => map.getCanvas().style.cursor = 'pointer');
    map.on('mouseleave', id, () => map.getCanvas().style.cursor = '');
  });

  // â”€â”€ Layer Toggles â”€â”€
  document.getElementById('toggle-osm').addEventListener('change', e => {
    ['osm-env-circle','osm-env-label'].forEach(id =>
      map.setLayoutProperty(id,'visibility', e.target.checked ? 'visible' : 'none'));
  });
  document.getElementById('toggle-core').addEventListener('change', e =>
    map.setLayoutProperty('eco-core-circle','visibility', e.target.checked ? 'visible' : 'none'));
  document.getElementById('toggle-comm').addEventListener('change', e =>
    map.setLayoutProperty('eco-community-circle','visibility', e.target.checked ? 'visible' : 'none'));

  document.getElementById('statusbar').textContent = 'Karte bereit â€“ OSM Daten werden geladenâ€¦';
});
</script>
</body>
</html>