<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EcoAtlas ‚Äî Meldung einreichen</title>
  <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css">
  <script src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:       #080f08;
      --bg2:      #0a150a;
      --bg3:      #0d1a0d;
      --border:   #1e3a1e;
      --border2:  #2a4a2a;
      --green:    #4caf50;
      --green-l:  #81c784;
      --green-d:  #558b55;
      --green-x:  #3a5a3a;
      --text:     #c8e6c9;
      --text-l:   #e8f5e9;
      --warn-bg:  #1a1200;
      --warn-b:   #3a3000;
      --warn-t:   #c8b560;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'IBM Plex Mono', 'Courier New', monospace;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
    header {
      width: 100%; max-width: 720px;
      display: flex; align-items: center; justify-content: space-between;
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
    }
    header a { color: var(--green-d); text-decoration: none; font-size: 12px; letter-spacing: .05em; }
    header .title { font-size: 13px; font-weight: 700; letter-spacing: .08em; color: var(--green-l); text-transform: uppercase; }
    header .anon { font-size: 10px; color: var(--green); border: 1px solid var(--green-x); border-radius: 3px; padding: 2px 7px; letter-spacing: .05em; }

    /* ‚îÄ‚îÄ Stepper ‚îÄ‚îÄ */
    nav#stepper {
      width: 100%; max-width: 720px;
      display: flex; padding: 12px 20px; gap: 4px;
      border-bottom: 1px solid var(--border);
    }
    .step { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 4px; padding: 8px 4px; border-radius: 4px; opacity: .3; transition: opacity .2s; cursor: default; }
    .step.done { opacity: .65; cursor: pointer; }
    .step.active { opacity: 1; background: var(--bg3); }
    .step-icon { font-size: 16px; color: var(--green); line-height: 1; }
    .step-label { font-size: 9px; letter-spacing: .08em; text-transform: uppercase; color: var(--green-l); }

    /* ‚îÄ‚îÄ Main ‚îÄ‚îÄ */
    main { width: 100%; max-width: 720px; padding: 20px; display: flex; flex-direction: column; gap: 16px; }

    /* ‚îÄ‚îÄ Card ‚îÄ‚îÄ */
    .card { background: var(--bg2); border: 1px solid var(--border); border-radius: 8px; padding: 20px; display: flex; flex-direction: column; gap: 14px; }
    .card-title { font-size: 14px; font-weight: 700; letter-spacing: .05em; color: var(--text-l); text-transform: uppercase; }
    .card-hint { font-size: 11px; color: var(--green-d); line-height: 1.6; }

    /* ‚îÄ‚îÄ Form Elements ‚îÄ‚îÄ */
    .field { display: flex; flex-direction: column; gap: 6px; }
    label { font-size: 10px; color: var(--green-d); letter-spacing: .06em; text-transform: uppercase; }
    input, select, textarea {
      background: var(--bg3); border: 1px solid var(--border2); border-radius: 4px;
      color: var(--text); font-family: inherit; font-size: 12px; padding: 8px 10px;
      outline: none; width: 100%;
      transition: border-color .15s;
    }
    input:focus, select:focus, textarea:focus { border-color: var(--green); }
    textarea { resize: vertical; }
    .two-col { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

    /* ‚îÄ‚îÄ Suche ‚îÄ‚îÄ */
    .search-row { display: flex; gap: 8px; }
    .search-row input { flex: 1; }
    .btn-search {
      background: #1a3a1a; border: 1px solid #3a6a3a; border-radius: 4px;
      color: var(--green-l); cursor: pointer; font-family: inherit; font-size: 12px;
      padding: 8px 16px; white-space: nowrap; transition: background .15s;
    }
    .btn-search:hover { background: #254a25; }

    #search-results { list-style: none; background: var(--bg3); border: 1px solid var(--border); border-radius: 4px; overflow: hidden; display: none; }
    #search-results li { padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #1a2e1a; display: flex; flex-direction: column; gap: 2px; }
    #search-results li:hover { background: #0f200f; }
    #search-results li:last-child { border-bottom: none; }
    .r-name { font-size: 12px; color: var(--text-l); font-weight: 600; }
    .r-sub  { font-size: 10px; color: var(--green-d); }

    /* ‚îÄ‚îÄ Karte ‚îÄ‚îÄ */
    #map-wrap { position: relative; border-radius: 6px; overflow: hidden; border: 1px solid var(--border); }
    #map { width: 100%; height: 280px; }
    #map-hint {
      position: absolute; inset: 0; display: flex; align-items: center; justify-content: center;
      font-size: 11px; color: var(--green-d); pointer-events: none;
      background: rgba(8,15,8,.5); transition: opacity .3s;
    }

    .coord-row {
      display: flex; align-items: center; gap: 10px;
      background: var(--bg3); border: 1px solid var(--border); border-radius: 4px; padding: 6px 10px;
    }
    .coord-lbl { font-size: 10px; color: var(--green-d); letter-spacing: .05em; }
    .coord-val { font-size: 12px; color: var(--green-l); flex: 1; }
    .btn-clear { background: none; border: none; color: var(--green-x); cursor: pointer; font-size: 12px; padding: 0 4px; }

    /* ‚îÄ‚îÄ Upload ‚îÄ‚îÄ */
    #drop-zone {
      border: 1.5px dashed var(--green-x); border-radius: 6px; background: var(--bg3);
      padding: 24px 16px; display: flex; flex-direction: column; align-items: center; gap: 6px;
      cursor: pointer; transition: border-color .15s, background .15s;
    }
    #drop-zone.dragging { border-color: var(--green); background: #0f2b0f; }
    #drop-zone .dz-icon { font-size: 28px; color: var(--green); line-height: 1; }
    #drop-zone .dz-text { color: var(--text); font-size: 14px; font-weight: 600; letter-spacing: .02em; }
    #drop-zone .dz-hint { color: var(--green-d); font-size: 11px; letter-spacing: .04em; }

    #file-list { list-style: none; display: flex; flex-direction: column; gap: 6px; }
    .file-item {
      display: flex; align-items: center; justify-content: space-between;
      background: #111d11; border: 1px solid var(--border); border-radius: 5px; padding: 8px 10px; gap: 10px;
    }
    .file-left { display: flex; align-items: center; gap: 10px; min-width: 0; flex: 1; }
    .file-meta { display: flex; flex-direction: column; min-width: 0; }
    .file-name { font-size: 12px; font-weight: 600; color: var(--text-l); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 220px; }
    .file-sub  { font-size: 10px; color: var(--green-d); margin-top: 2px; }
    .file-right { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }

    .prog-wrap { position: relative; width: 100px; height: 16px; background: #1e3a1e; border-radius: 3px; overflow: hidden; }
    .prog-bar  { position: absolute; top: 0; left: 0; height: 100%; background: var(--green); transition: width .2s; }
    .prog-lbl  { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; font-size: 9px; color: var(--text-l); font-weight: 700; letter-spacing: .05em; }

    .badge-done  { color: var(--green-l); font-size: 11px; font-weight: 700; }
    .badge-error { color: #ef9a9a; font-size: 11px; font-weight: 700; cursor: help; }
    .btn-retry { background: none; border: 1px solid var(--green-x); border-radius: 3px; color: var(--green-l); cursor: pointer; font-size: 14px; padding: 2px 6px; }
    .btn-remove { background: none; border: none; color: var(--green-x); cursor: pointer; font-size: 12px; padding: 2px 4px; }
    .upload-hint { font-size: 10px; color: var(--green-x); line-height: 1.5; letter-spacing: .03em; }

    /* ‚îÄ‚îÄ Zusammenfassung ‚îÄ‚îÄ */
    .summary-grid { display: flex; flex-direction: column; gap: 8px; }
    .summary-row { display: flex; gap: 12px; border-bottom: 1px solid #0f200f; padding-bottom: 8px; }
    .s-key { font-size: 10px; color: var(--green-d); letter-spacing: .05em; text-transform: uppercase; min-width: 110px; padding-top: 2px; }
    .s-val { font-size: 12px; color: var(--text); flex: 1; word-break: break-word; }

    .warn-box { display: flex; gap: 10px; background: var(--warn-bg); border: 1px solid var(--warn-b); border-radius: 5px; padding: 12px 14px; font-size: 11px; color: var(--warn-t); line-height: 1.6; align-items: flex-start; }
    .warn-icon { font-size: 16px; flex-shrink: 0; margin-top: 1px; }

    /* ‚îÄ‚îÄ Navigation ‚îÄ‚îÄ */
    .nav-row { display: flex; justify-content: space-between; gap: 10px; }
    .btn-back { background: none; border: 1px solid var(--border2); border-radius: 4px; color: var(--green-d); cursor: pointer; font-family: inherit; font-size: 12px; padding: 10px 20px; letter-spacing: .05em; }
    .btn-next {
      background: var(--green); border: none; border-radius: 4px;
      color: var(--bg); cursor: pointer; font-family: inherit; font-size: 12px; font-weight: 700;
      padding: 10px 24px; letter-spacing: .06em; text-transform: uppercase; transition: background .15s, opacity .15s;
    }
    .btn-next:disabled { opacity: .35; cursor: not-allowed; }
    .btn-next:hover:not(:disabled) { background: #66bb6a; }
    .btn-next.full { width: 100%; margin-top: 16px; }

    /* ‚îÄ‚îÄ Erfolg ‚îÄ‚îÄ */
    #success { display: none; flex-direction: column; align-items: center; gap: 16px; padding: 60px 32px; text-align: center; max-width: 480px; }
    .success-icon { width: 64px; height: 64px; border-radius: 50%; background: #1a3a1a; border: 2px solid var(--green); display: flex; align-items: center; justify-content: center; font-size: 28px; color: var(--green); }
    .success-title { font-size: 18px; color: var(--text-l); font-weight: 700; }
    .success-text { font-size: 12px; color: var(--green-l); line-height: 1.7; }
    .success-id { font-size: 10px; color: var(--green-x); letter-spacing: .05em; }
    .success-link { font-size: 12px; color: var(--green); text-decoration: none; border: 1px solid var(--green-x); border-radius: 4px; padding: 8px 20px; margin-top: 8px; }

    .hidden { display: none !important; }
  </style>
</head>
<body>

<header>
  <a href="/">‚Üê Karte</a>
  <span class="title">Umweltproblem melden</span>
  <span class="anon">anonym m√∂glich</span>
</header>

<nav id="stepper">
  <div class="step active" data-step="ort">
    <span class="step-icon">‚óé</span>
    <span class="step-label">Standort</span>
  </div>
  <div class="step" data-step="was">
    <span class="step-icon">‚â°</span>
    <span class="step-label">Angaben</span>
  </div>
  <div class="step" data-step="belege">
    <span class="step-icon">‚¨Ü</span>
    <span class="step-label">Belege</span>
  </div>
  <div class="step" data-step="absenden">
    <span class="step-icon">‚Üí</span>
    <span class="step-label">Absenden</span>
  </div>
</nav>

<main id="main-content">

  <!-- Schritt 1: Standort -->
  <div id="step-ort" class="card">
    <div class="card-title">Wo befindet sich der Standort?</div>
    <div class="search-row">
      <input id="search-input" type="text" placeholder="Ort, Adresse oder Name suchen‚Ä¶">
      <button class="btn-search" onclick="doSearch()">Suchen</button>
    </div>
    <ul id="search-results"></ul>
    <div id="map-wrap">
      <div id="map"></div>
      <div id="map-hint">Auf der Karte klicken oder oben suchen</div>
    </div>
    <div class="coord-row hidden" id="coord-row">
      <span class="coord-lbl">Koordinaten</span>
      <span class="coord-val" id="coord-display">‚Äî</span>
      <button class="btn-clear" onclick="clearCoord()">‚úï</button>
    </div>
    <div class="field">
      <label>Genauigkeit / Radius</label>
      <select id="radius">
        <option value="10">Punkt (~10 m)</option>
        <option value="100" selected>Nahbereich (~100 m)</option>
        <option value="500">Gebiet (~500 m)</option>
        <option value="2000">Gro√ügebiet (~2 km)</option>
      </select>
    </div>
    <div class="nav-row">
      <span></span>
      <button class="btn-next" id="btn-ort-next" disabled onclick="goTo('was')">Weiter ‚Üí</button>
    </div>
  </div>

  <!-- Schritt 2: Angaben -->
  <div id="step-was" class="card hidden">
    <div class="card-title">Was wird gemeldet?</div>
    <div class="field">
      <label>Name / Bezeichnung *</label>
      <input id="f-name" type="text" placeholder="z.B. Deponie Nordring, Werk Bitterfeld-Nord">
    </div>
    <div class="field">
      <label>Typ *</label>
      <select id="f-typ">
        <option value="">‚Äî bitte w√§hlen ‚Äî</option>
        <option>Deponie</option><option>Industrieanlage</option><option>Kraftwerk</option>
        <option>Kl√§ranlage</option><option>Bergbau</option><option>Landwirtschaft</option>
        <option>Verkehr</option><option>Illegale Entsorgung</option><option>Sonstiges</option>
      </select>
    </div>
    <div class="field">
      <label>Beschreibung</label>
      <textarea id="f-beschreibung" rows="3" placeholder="Was wurde beobachtet? Geruch, Farbe, H√§ufigkeit‚Ä¶"></textarea>
    </div>
    <div class="two-col">
      <div class="field"><label>Aktiv seit</label><input id="f-von" type="date"></div>
      <div class="field"><label>Aktiv bis</label><input id="f-bis" type="date"></div>
    </div>
    <div class="field">
      <label>Verantwortlicher / Betreiber</label>
      <input id="f-verantwortlicher" type="text" placeholder="Firmenname, Beh√∂rde‚Ä¶">
    </div>
    <div class="field">
      <label>Quelle / Link</label>
      <input id="f-quelle" type="text" placeholder="https://‚Ä¶ oder Wikipedia-Seite">
    </div>
    <div class="field" style="border-top:1px solid var(--border);padding-top:14px">
      <label>Emission / Messwert (optional)</label>
      <div class="two-col">
        <select id="f-emission-typ">
          <option value="">‚Äî Typ ‚Äî</option>
          <option>CO‚ÇÇ</option><option>CH‚ÇÑ</option><option>NO‚Çì</option><option>SO‚ÇÇ</option>
          <option>PM2.5</option><option>PM10</option><option>Abwasser</option>
          <option>Schwermetalle</option><option>PFAS</option><option>L√§rm</option><option>Sonstiges</option>
        </select>
        <div style="display:flex;gap:6px">
          <input id="f-emission-wert" type="number" placeholder="Wert" style="width:55%">
          <select id="f-emission-einheit" style="width:45%">
            <option>t/Jahr</option><option>kg/h</option><option>mg/m¬≥</option>
            <option>Œºg/m¬≥</option><option>dB</option><option>m¬≥/Tag</option><option>Bq/m¬≥</option>
          </select>
        </div>
      </div>
    </div>
    <div class="nav-row">
      <button class="btn-back" onclick="goTo('ort')">‚Üê Zur√ºck</button>
      <button class="btn-next" id="btn-was-next" disabled onclick="goTo('belege')">Weiter ‚Üí</button>
    </div>
  </div>

  <!-- Schritt 3: Belege -->
  <div id="step-belege" class="card hidden">
    <div class="card-title">Belege hochladen</div>
    <p class="card-hint">Fotos, PDFs, Videos oder Geodaten st√§rken die Glaubw√ºrdigkeit. Alle Dateien werden auf Viren gepr√ºft.</p>
    <div id="drop-zone">
      <span class="dz-icon">‚¨Ü</span>
      <span class="dz-text">Dateien hier ablegen oder klicken</span>
      <span class="dz-hint">JPG ¬∑ PNG ¬∑ PDF ¬∑ MP4 ¬∑ GeoJSON ¬∑ KML ¬∑ Anonym erlaubt</span>
    </div>
    <input type="file" id="file-input" multiple accept=".jpg,.jpeg,.png,.pdf,.mp4,.geojson,.kml" style="display:none">
    <ul id="file-list"></ul>
    <p class="upload-hint">Dateien werden nach dem Upload auf Viren gepr√ºft und dann als Anh√§nge zur Meldung gespeichert.</p>
    <div class="nav-row">
      <button class="btn-back" onclick="goTo('was')">‚Üê Zur√ºck</button>
      <button class="btn-next" onclick="goTo('absenden')">Weiter ‚Üí</button>
    </div>
  </div>

  <!-- Schritt 4: Absenden -->
  <div id="step-absenden" class="card hidden">
    <div class="card-title">Zusammenfassung</div>
    <div class="summary-grid" id="summary-grid"></div>
    <div class="warn-box">
      <span class="warn-icon">‚ö†</span>
      <span>Diese Meldung erscheint zun√§chst als <strong>Quarant√§ne-Eintrag</strong> mit orangenem Badge auf der Karte. Nach Community-Votes und Moderator-Pr√ºfung wird sie in den verifizierten Datensatz √ºbernommen.</span>
    </div>
    <div class="nav-row">
      <button class="btn-back" onclick="goTo('belege')">‚Üê Zur√ºck</button>
      <button class="btn-next full" id="btn-submit" onclick="submitForm()">Meldung abschicken ‚Üí</button>
    </div>
  </div>

</main>

<!-- Erfolg -->
<div id="success">
  <div class="success-icon">‚úì</div>
  <div class="success-title">Meldung eingegangen</div>
  <p class="success-text">Deine Meldung wurde als Quarant√§ne-Eintrag gespeichert und ist sofort auf der Karte sichtbar. Community-Votes und Moderator-Pr√ºfung entscheiden √ºber die √úbernahme in den verifizierten Datensatz.</p>
  <div class="success-id" id="success-id"></div>
  <a href="/" class="success-link">‚Üê Zur√ºck zur Karte</a>
</div>

<script>
const TILE_SERVER = 'http://localhost:8080';
const STEPS = ['ort','was','belege','absenden'];
const submissionId = `sub_${Date.now()}_${Math.random().toString(36).slice(2)}`;

let state = {
  lat: null, lng: null, ortLabel: '',
  attachments: [],
  currentStep: 'ort',
};

let map, marker;

// ‚îÄ‚îÄ Karte initialisieren ‚îÄ‚îÄ
function initMap() {
  if (map) return;
  map = new maplibregl.Map({
    container: 'map',
    style: {
      version: 8,
      sources: { osm: { type: 'raster', tiles: ['https://tile.openstreetmap.org/{z}/{x}/{y}.png'], tileSize: 256 }},
      layers:  [{ id: 'osm', type: 'raster', source: 'osm' }],
    },
    center: [10.45, 51.16],
    zoom: 5,
  });

  map.on('click', (e) => {
    const { lng, lat } = e.lngLat;
    setCoord(lat, lng, `${lat.toFixed(5)}, ${lng.toFixed(5)}`);
    placeMarker(lng, lat);
  });
}

function setCoord(lat, lng, label) {
  state.lat = parseFloat(lat.toFixed(6));
  state.lng = parseFloat(lng.toFixed(6));
  state.ortLabel = label;
  document.getElementById('coord-display').textContent = `${state.lat}, ${state.lng}`;
  document.getElementById('coord-row').classList.remove('hidden');
  document.getElementById('map-hint').style.opacity = '0';
  document.getElementById('btn-ort-next').disabled = false;
}

function clearCoord() {
  state.lat = null; state.lng = null; state.ortLabel = '';
  document.getElementById('coord-row').classList.add('hidden');
  document.getElementById('map-hint').style.opacity = '1';
  document.getElementById('btn-ort-next').disabled = true;
  if (marker) { marker.remove(); marker = null; }
}

function placeMarker(lng, lat) {
  if (marker) marker.remove();
  const el = document.createElement('div');
  el.style.cssText = 'width:18px;height:18px;border-radius:50%;background:#4caf50;border:2px solid #e8f5e9;box-shadow:0 0 0 4px rgba(76,175,80,.25)';
  marker = new maplibregl.Marker({ element: el }).setLngLat([lng, lat]).addTo(map);
}

// ‚îÄ‚îÄ Ortssuche ‚îÄ‚îÄ
async function doSearch() {
  const q = document.getElementById('search-input').value.trim();
  if (!q) return;
  const btn = document.querySelector('.btn-search');
  btn.textContent = '‚Ä¶'; btn.disabled = true;
  try {
    const res = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(q)}&format=json&limit=5&countrycodes=de,at,ch`, { headers: {'Accept-Language':'de'} });
    const data = await res.json();
    const ul = document.getElementById('search-results');
    ul.innerHTML = '';
    if (data.length === 0) { ul.style.display = 'none'; return; }
    data.forEach(r => {
      const li = document.createElement('li');
      const parts = r.display_name.split(',');
      li.innerHTML = `<span class="r-name">${parts[0]}</span><span class="r-sub">${parts.slice(1,3).join(',')}</span>`;
      li.onclick = () => {
        const lat = parseFloat(r.lat), lng = parseFloat(r.lon);
        setCoord(lat, lng, r.display_name);
        placeMarker(lng, lat);
        map.flyTo({ center: [lng, lat], zoom: 13 });
        document.getElementById('search-input').value = parts[0];
        ul.style.display = 'none';
      };
      ul.appendChild(li);
    });
    ul.style.display = 'block';
  } finally {
    btn.textContent = 'Suchen'; btn.disabled = false;
  }
}

document.getElementById('search-input').addEventListener('keydown', e => e.key === 'Enter' && doSearch());

// ‚îÄ‚îÄ Schritt-Navigation ‚îÄ‚îÄ
function goTo(step) {
  document.getElementById(`step-${state.currentStep}`).classList.add('hidden');
  document.getElementById(`step-${step}`).classList.remove('hidden');

  // Stepper aktualisieren
  const stepIdx = STEPS.indexOf(step);
  document.querySelectorAll('.step').forEach((el, i) => {
    el.classList.remove('active','done');
    if (i === stepIdx) el.classList.add('active');
    else if (i < stepIdx) { el.classList.add('done'); el.onclick = () => goTo(STEPS[i]); }
  });

  state.currentStep = step;

  if (step === 'ort' && !map) setTimeout(initMap, 50);
  if (step === 'absenden') buildSummary();
}

// Karte beim ersten Schritt starten
setTimeout(initMap, 100);

// ‚îÄ‚îÄ "Weiter" in Schritt 2 freischalten ‚îÄ‚îÄ
function checkWasForm() {
  const ok = document.getElementById('f-name').value.trim().length > 0 &&
             document.getElementById('f-typ').value.length > 0;
  document.getElementById('btn-was-next').disabled = !ok;
}
document.getElementById('f-name').addEventListener('input', checkWasForm);
document.getElementById('f-typ').addEventListener('change', checkWasForm);

// ‚îÄ‚îÄ Upload ‚îÄ‚îÄ
const EXT_MIME = { jpg:'image/jpeg', jpeg:'image/jpeg', png:'image/png', pdf:'application/pdf', mp4:'video/mp4', geojson:'application/geo+json', kml:'application/vnd.google-earth.kml+xml' };
const MAX_MB   = { 'image/jpeg':20, 'image/png':20, 'application/pdf':50, 'video/mp4':500, 'application/geo+json':5, 'application/vnd.google-earth.kml+xml':5 };
const MIME_LBL = { 'image/jpeg':'JPG','image/png':'PNG','application/pdf':'PDF','video/mp4':'MP4','application/geo+json':'GeoJSON','application/vnd.google-earth.kml+xml':'KML' };
const FILE_ICONS = { 'image/jpeg':'üñº','image/png':'üñº','application/pdf':'üìÑ','video/mp4':'üé•','application/geo+json':'üó∫','application/vnd.google-earth.kml+xml':'üó∫' };

function fmtBytes(b) {
  if (b < 1024) return `${b} B`;
  if (b < 1048576) return `${(b/1024).toFixed(1)} KB`;
  return `${(b/1048576).toFixed(1)} MB`;
}

const dz = document.getElementById('drop-zone');
dz.addEventListener('click', () => document.getElementById('file-input').click());
dz.addEventListener('dragover', e => { e.preventDefault(); dz.classList.add('dragging'); });
dz.addEventListener('dragleave', () => dz.classList.remove('dragging'));
dz.addEventListener('drop', e => { e.preventDefault(); dz.classList.remove('dragging'); handleFiles(e.dataTransfer.files); });
document.getElementById('file-input').addEventListener('change', e => handleFiles(e.target.files));

function handleFiles(files) {
  Array.from(files).forEach(f => uploadFile(f));
}

async function uploadFile(file) {
  const ext = file.name.split('.').pop()?.toLowerCase() ?? '';
  const mime = EXT_MIME[ext];
  if (!mime) return alert(`Dateityp .${ext} nicht erlaubt`);
  if (file.size > MAX_MB[mime] * 1048576) return alert(`Datei zu gro√ü (max ${MAX_MB[mime]} MB)`);

  const id = `f_${Date.now()}_${Math.random().toString(36).slice(2)}`;
  addFileItem(id, file, mime);

  try {
    // 1. Presign
    updateProgress(id, 5, 'URL anfordern‚Ä¶');
    const pRes = await fetch(`${TILE_SERVER}/upload/presign`, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ filename: file.name, contentType: mime, submissionId }),
    });
    if (!pRes.ok) { const e = await pRes.json(); throw new Error(e.error ?? `Presign ${pRes.status}`); }
    const { uploadUrl, objectPath } = await pRes.json();

    // 2. PUT zu GCS
    await new Promise((resolve, reject) => {
      const xhr = new XMLHttpRequest();
      xhr.upload.onprogress = e => {
        if (e.lengthComputable) updateProgress(id, 10 + Math.round(e.loaded/e.total*80), `${Math.round(e.loaded/e.total*100)}%`);
      };
      xhr.onload = () => xhr.status >= 200 && xhr.status < 300 ? resolve() : reject(new Error(`GCS ${xhr.status}`));
      xhr.onerror = () => reject(new Error('Netzwerkfehler'));
      xhr.open('PUT', uploadUrl);
      xhr.setRequestHeader('Content-Type', mime);
      xhr.send(file);
    });

    // 3. Best√§tigen
    updateProgress(id, 95, 'Best√§tigen‚Ä¶');
    const cRes = await fetch(`${TILE_SERVER}/upload/confirm`, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ objectPath, submissionId }),
    });
    if (!cRes.ok) { const e = await cRes.json(); throw new Error(e.error ?? 'Best√§tigung fehlgeschlagen'); }

    markDone(id, objectPath);
    state.attachments.push(objectPath);

  } catch (err) {
    markError(id, err.message);
  }
}

function addFileItem(id, file, mime) {
  const li = document.createElement('li');
  li.className = 'file-item'; li.id = `fi_${id}`;
  li.innerHTML = `
    <div class="file-left">
      <span style="font-size:20px">${FILE_ICONS[mime]??'üìé'}</span>
      <div class="file-meta">
        <span class="file-name">${file.name}</span>
        <span class="file-sub">${fmtBytes(file.size)} ¬∑ ${MIME_LBL[mime]??''}</span>
      </div>
    </div>
    <div class="file-right">
      <div class="prog-wrap" id="pw_${id}">
        <div class="prog-bar" id="pb_${id}" style="width:5%"></div>
        <div class="prog-lbl" id="pl_${id}">‚Ä¶</div>
      </div>
      <button class="btn-remove" onclick="removeFile('${id}')">‚úï</button>
    </div>`;
  document.getElementById('file-list').appendChild(li);
}

function updateProgress(id, pct, lbl) {
  const pb = document.getElementById(`pb_${id}`);
  const pl = document.getElementById(`pl_${id}`);
  if (pb) pb.style.width = `${pct}%`;
  if (pl) pl.textContent = lbl;
}

function markDone(id) {
  const pw = document.getElementById(`pw_${id}`);
  if (pw) pw.outerHTML = `<span class="badge-done">‚úì Hochgeladen</span>`;
}

function markError(id, msg) {
  const pw = document.getElementById(`pw_${id}`);
  if (pw) pw.outerHTML = `<span class="badge-error" title="${msg}">‚úó Fehler</span>`;
}

function removeFile(id) {
  document.getElementById(`fi_${id}`)?.remove();
}

// ‚îÄ‚îÄ Zusammenfassung ‚îÄ‚îÄ
function buildSummary() {
  const rows = [
    ['Standort',    state.ortLabel || `${state.lat}, ${state.lng}`],
    ['Name',        document.getElementById('f-name').value],
    ['Typ',         document.getElementById('f-typ').value],
    ['Beschreibung',document.getElementById('f-beschreibung').value],
    ['Aktiv von',   document.getElementById('f-von').value],
    ['Aktiv bis',   document.getElementById('f-bis').value],
    ['Betreiber',   document.getElementById('f-verantwortlicher').value],
    ['Quelle',      document.getElementById('f-quelle').value],
    ['Emission',    [document.getElementById('f-emission-typ').value, document.getElementById('f-emission-wert').value, document.getElementById('f-emission-einheit').value].filter(Boolean).join(' ')],
    ['Anh√§nge',     `${state.attachments.length} Datei(en)`],
  ].filter(([,v]) => v && v.trim && v.trim().length > 0 || typeof v === 'string' && v.includes('Datei'));

  document.getElementById('summary-grid').innerHTML = rows.map(([k,v]) =>
    `<div class="summary-row"><span class="s-key">${k}</span><span class="s-val">${v}</span></div>`
  ).join('');
}

// ‚îÄ‚îÄ Absenden ‚îÄ‚îÄ
async function submitForm() {
  const btn = document.getElementById('btn-submit');
  btn.disabled = true; btn.textContent = 'Wird gesendet‚Ä¶';

  const payload = {
    submission_id:        submissionId,
    submission_type:      'new_emitter',
    user_id:              'anonymous',
    status:               'pending',
    proposed_name:        document.getElementById('f-name').value,
    proposed_type:        document.getElementById('f-typ').value,
    proposed_description: document.getElementById('f-beschreibung').value || null,
    proposed_geo_point:   state.lat ? { lat: state.lat, lng: state.lng } : null,
    proposed_emission_type: document.getElementById('f-emission-typ').value || null,
    proposed_value:       parseFloat(document.getElementById('f-emission-wert').value) || null,
    proposed_unit:        document.getElementById('f-emission-einheit').value,
    proposed_active_from: document.getElementById('f-von').value || null,
    proposed_active_to:   document.getElementById('f-bis').value || null,
    proposed_source_url:  document.getElementById('f-quelle').value || null,
    proposed_responsible: document.getElementById('f-verantwortlicher').value || null,
    attachments:          state.attachments,
  };

  try {
    const res = await fetch(`${TILE_SERVER}/api/community/submit`, {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(payload),
    });
    if (!res.ok) throw new Error(`Fehler ${res.status}`);
    document.getElementById('main-content').style.display = 'none';
    document.getElementById('stepper').style.display = 'none';
    document.getElementById('success-id').textContent = `ID: ${submissionId}`;
    document.getElementById('success').style.display = 'flex';
  } catch (err) {
    alert(`Fehler: ${err.message}`);
    btn.disabled = false; btn.textContent = 'Meldung abschicken ‚Üí';
  }
}
</script>
</body>
</html>